<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visualização de Dados - Álbuns</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
  <!-- Importação do Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">
  <header class="bg-dark text-white text-center py-3">
    <h1 class="h4">Visualização de Dados dos Álbuns</h1>
  </header>

  <main class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow p-4">
          <h2 class="h5 text-center mb-4">Distribuição de Álbuns por Categoria</h2>
          <!-- Canvas onde o Chart.js irá desenhar o gráfico -->
          <canvas id="graficoAlbunsPorCategoria"></canvas>
          <div class="text-center mt-4">
            <a href="index.html" class="btn btn-outline-secondary">Voltar para Home</a>
          </div>
        </div>
      </div>
    </div>
    
  </main>

  <script>
    const API_URL = "http://localhost:3000/albuns";

    /**
     * Função para buscar os dados da API e processá-los para o Chart.js
     */
    async function carregarEProcessarDados() {
      try {
        const resposta = await fetch(API_URL);
        if (!resposta.ok) throw new Error(`Erro ${resposta.status}`);
        const albuns = await resposta.json();

        // 1. Processar dados: Contar álbuns por categoria
        const contagemCategorias = {};
        albuns.forEach(album => {
          const categoria = album.categoria || 'Não Categorizado'; // Trata categorias vazias
          contagemCategorias[categoria] = (contagemCategorias[categoria] || 0) + 1;
        });

        // 2. Preparar dados para o Chart.js
        const labels = Object.keys(contagemCategorias);
        const data = Object.values(contagemCategorias);
        
        // Cores dinâmicas para o gráfico
        const coresFundo = labels.map((_, index) => {
          // Cores base para um visual agradável
          const corBase = 360 / labels.length * index;
          return `hsl(${corBase}, 70%, 50%)`; // HSL para cores vibrantes
        });
        const coresBorda = coresFundo.map(cor => cor.replace('50%', '30%'));


        // 3. Renderizar o gráfico
        renderizarGrafico(labels, data, coresFundo, coresBorda);

      } catch (err) {
        console.error("Erro ao carregar ou processar dados da API:", err);
        const canvas = document.getElementById('graficoAlbunsPorCategoria');
        if(canvas) canvas.parentElement.innerHTML = `<p class="text-center text-danger">Erro ao carregar os dados. Verifique se o servidor JSON está rodando em ${API_URL}.</p>`;
      }
    }

    function renderizarGrafico(labels, data, backgroundColors, borderColors) {
      const ctx = document.getElementById('graficoAlbunsPorCategoria');
      
      new Chart(ctx, {
        type: 'bar', // Tipo de gráfico: barras
        data: {
          labels: labels,
          datasets: [{
            label: 'Número de Álbuns',
            data: data,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  if (value % 1 === 0) {
                    return value;
                  }
                }
              },
              title: {
                display: true,
                text: 'Quantidade de Álbuns'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Categoria'
              }
            }
          },
          plugins: {
            legend: {
              display: false 
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += context.parsed.y;
                  }
                  return label;
                }
              }
            }
          }
        }
      });
    }
    document.addEventListener('DOMContentLoaded', carregarEProcessarDados);
  </script>
</body>
</html>